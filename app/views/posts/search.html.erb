<!-- Header
=================== -->
<header class="row">
  <nav>
    <div class="nav-wrapper" style="height: 120%;">
    <!-- logo -->
    <%= link_to image_tag('logo.png', class:'logo col s11 m5 l3'), root_path %>
    <!-- search -->
      <ul class="right col s12 m5 l4 offset-l4 grey lighten-5">
        <li><form action="/search" accept-charset="UTF-8" method="get">
          <div class="input-field right col l12">
            <input name="utf8" type="hidden" value="âœ“" required>
            <input type="text" name="name" id="search">
            <label for="search" id="search"></label>
            <i class="material-icons right">search</i>
          </div>
        </form></li>
        <li><%= link_to "Previous Page", :back, class:'col l12 previous grey lighten-5 deep-purple-text text-darken-2' %></li>
      </ul>
    </div>
  </nav>
</header>

<!-- Body
=================== -->

<!-- google map -->
<div class="set  col l12" id="map-canvas"></div>

<!-- search results -->
  <h1 class="headline">Search results for "<%= @query %>" </h1>
    <hr>
      <h2 class='sub-head'>These are your experiences based on your search. </h2>

<!-- group of search results -->
<!--wrapped in hidden span tags so that it can be grabbed by the map script by DOM manipulation-->
<div class="row">
  <% @locations.each do |l| %>
    <% if l.address %>
      <span style="display: none;"><%= l.address %>, <%= l.city %> <%= l.state %>, <%= l.location_name %></span>
    <% else %>
      <span style="display: none;"><%= l.cross_st1 %> and <%= l.cross_st2 %>, <%= l.city %> <%= l.state %>, <%= l.location_name %></span>
    <% end %>
  <% end %>

  <% @results.each do |r| %>
  <div class="col s10 m4 l3 offset-s1 offset-m1">  
    <div class="card">
      <div class="card-image">
        <div><%= link_to image_tag(r.image, class:'posts-image results-image responsive-img'), r %></div>
        <span class="card-title"><%= link_to r.title, r, class:'title' %></span>
      </div>
        <div class="card-content">
          <p class="p"><%= r.content[0...50]+"..." %></p>
        </div>
    </div>
  </div>
    <% end %>
</div>


<!-- Map Script 
================================-->
<script type="text/javascript">
var markersArray = [];
var NY_LAT = 40.735189;
var NY_LNG = -73.991829;
var QUERY_DELAY = 400;
var inactive = false;
$(document).ready(function() {
  if ($('#map-canvas')){
    // initialize the map on load
    manyMaps();

  /**
   * Initializes the map and some events on page load
   */
    function manyMaps() {
    // Define some options for the map
    var mapOptions = {
      center: new google.maps.LatLng(NY_LAT, NY_LNG),
      zoom: 16,
      styles: [{"featureType":"landscape.natural","elementType":"geometry.fill","stylers":[{"visibility":"on"},{"color":"#e0efef"}]},{"featureType":"poi","elementType":"geometry.fill","stylers":[{"visibility":"on"},{"hue":"#1900ff"},{"color":"#c0e8e8"}]},{"featureType":"road","elementType":"geometry","stylers":[{"lightness":100},{"visibility":"simplified"}]},{"featureType":"road","elementType":"labels","stylers":[{"visibility":"off"}]},{"featureType":"transit.line","elementType":"geometry","stylers":[{"visibility":"on"},{"lightness":700}]},{"featureType":"water","elementType":"all","stylers":[{"color":"#7dcdcd"}]}],

      // hide controls
      panControl: true,
      streetViewControl: true,

      // reconfigure the zoom controls
      zoomControl: true,
      zoomControlOptions: {
        position: google.maps.ControlPosition.RIGHT_BOTTOM,
        style: google.maps.ZoomControlStyle.SMALL
      }
    };
    // create a new Google map with the options in the map element
     map = new google.maps.Map($('#map-canvas')[0], mapOptions);

      var classa = $('body').find('span').each(function(){
        var addArray = this.innerHTML.split(",");
        var addObj = {address: [addArray[0]], city: addArray[1]};
        var title = addArray[2];
        geocode_address(map, title, addObj);
      });
    };
  //converting address or cross streets into Lat Long
  function geocode_address(map, name, location_object) {
    var geocoder = new google.maps.Geocoder();

    var address = [
      location_object['address'][0],
      location_object['city']
      // location_object['country_code']
    ].join(', ');
    console.log("this is the outterscoped address "+ address);

    // geocode the address and get the lat/lng
    geocoder.geocode({address: address}, function(results, status) {
      if (status === google.maps.GeocoderStatus.OK) {

        // create a marker and drop it on the name on the geocoded location
        var marker = new google.maps.Marker({
          animation: google.maps.Animation.DROP,
          map: map,
          position: results[0].geometry.location,
          title: name
        });

        // save the marker object to calculate the map bound and zoom level
        markersArray.push(marker);
        var bounds = new google.maps.LatLngBounds()
        for (m = 0; m < markersArray.length; m++){
          bounds.extend(markersArray[m].position) 
        }
        map.fitBounds(bounds);
      } else {
        console.log("Geocode was not successful for the following reason: " + status);
      }
    });
  };
  /**
   * Remove all of the markers from the map by setting them
   * to null
   */
    function clearMarkers() {
      markersArray.forEach(function(marker) {
        marker.setMap(null);
      });
      markersArray = [];
    };
  }
});
</script>




